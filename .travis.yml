language: python

python:
  - 3.6

os:
  - linux

git:
  depth: false

addons:
  apt:
    packages:
      - swig

services: docker

sudo: required

env:
  global:
    - REPO_DIR=.
    - UNICODE_WIDTH=32
    - PLAT=x86_64
    - MB_PYTHON_VERSION=$TRAVIS_PYTHON_VERSION
    - VERSION=$(echo $TRAVIS_TAG)
    - BUILD_DEPENDS="cmake==3.13.3"
    - CONFIG_PATH=scripts/config.sh
    - TEST_DEPENDS="pytest"

matrix:
  fast_finish: true
  exclude:
    - python: 3.6
  include:
    - os: linux
      env: MB_PYTHON_VERSION=2.7
    - os: linux
      env: MB_PYTHON_VERSION=3.4
      if: tag IS present
    - os: linux
      env: MB_PYTHON_VERSION=3.5
    - os: linux
      env: MB_PYTHON_VERSION=3.6
    - os: linux
      env:
        - MB_PYTHON_VERSION=3.7
        - SOURCEDEPLOY=1

before_install:
  - echo "PWD is $PWD"
  - unset -f pushd
  - unset -f popd
  - git clone https://github.com/matthew-brett/multibuild
  - ls -l
  - source multibuild/common_utils.sh
  - source multibuild/travis_steps.sh
  - before_install

install:
  - pip install bandit
  - build_wheel $REPO_DIR $PLAT

before_script:
  - bandit -c bandit.yml -r src/xtgeo

script:
  - install_run $PLAT
  - mv wheelhouse dist

after_success:
  - ls -l ${TRAVIS_BUILD_DIR}/dist

before_deploy:
  - pip install numpy

deploy:
  - provider: pypi
    skip_cleanup: true
    skip_upload_docs: true
    distributions: build
    user: $PYPI_USER
    password: $PYPI_PASSWORD
      # secure: "YZTt5dTbdsiCcpNBRpcNZBfmxVsq6b3PPy7leyIw3MfPWLXJvvI+vkAYxF8HZD8N8dBQER6gG0PvG6IlUHzbqNvNjOLrBlm92xpLGZf+C6Q5bon1Z5jKk25oN7h+YM2n0z7DZ6XKjmRaGx7iA0thoU/io4VYEXAURSZ1vivRbgkMhgYKwc9YmYtyA/2n03nJ3wORyir559GMB4UzKDIMNNNJu5SgcqUvFSx68jjjXloPmG1fDZeSpVwXNKkoDJC1yAxGmSCfJknLWKXSa3Lg0JFq6qg4o8UEfF49W8jGKIr/V37ihhSnMn79fxv6JCahic/Pd/5BzssYWaC4Nzvi1A99KBo2iCO9lcXzcnmGS92KHyd6sl6aeoAcehZ5V45jJ4gxt7VpnjCwHV2znMrEbcQm9ZqJcjfV9wumMaP2/8G5MJkFE5MTNz9jBWDoREyLloSzBp1davUgPubQu2IZEeHoDtHXfgyzBA7txsAhMFt1KuTrsWgmMKnpfJxR3rRMkBY7y7cGYVCeg+J8+TpYyIlMJ3ep+gG/ig57uyedYjAofPysMW3ZVFbmqJL2burRcrLgJQuwdihDUzEXftT49Gusd6OWz5y/RBR5x0fKZzpAep/Yt4F4SS7yiVZ9ATHiXZS1Ad6mtsvcAslRmncFnHhZgDnBztaCDNMVKnBI7zY="
    on:
      tags: True
      repo: equinor/xtgeo
      # condition: -z $SOURCEDEPLOY
